/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <app_main.h>
#include <service.h>
#include <app_feature.h>

#if !defined(__SOFT_FP__) && defined(__ARM_FP)
  #warning "FPU is not initialized, but the project is compiling for an FPU. Please initialize the FPU before use."
#endif

volatile uint16_t adc_value = 0;
float converted_value = 0.0;
volatile uint8_t reset_reason = 0;

void service_init()
{
    // 1. Reset flags FIRST
    reset_reason_check(&reset_reason);

    // 2. Enable temp sensor in ADC common block
    adc_init_common(ADC_INDEPENDENT_MODE);
    adc_init_internal_channels(INNER_TEMPERATURE_SENSOR);

    // 3. Initialize ADC1 for channel 16 (internal temp sensor)
    adc_init_individual_modules(adc1_ptr, 16);

    // 4. Select channel in SQR3 (remove adc_set_sequence completely)
    adc1_ptr->SQR3 = 16;               // channel 16, first conversion
    adc1_ptr->SQR1 &= ~(0x0F << 20);   // sequence length = 1 conversion

    // 5. Start ADC in continuous mode
    adc_start_conversion(adc1_ptr);

    // 6. Freeze IWDG during debug
    dbgmcu_ptr->APB1_FZ |= (1 << 12);
}

void app_init()
{
    // empty for now
}

int main(void)
{
    service_init();
    app_init();

    while (1)
    {
        adc_get_value(adc1_ptr, &adc_value);
        adc_convert_value(adc_value, &converted_value, INNER_TEMPERATURE_SENSOR);

        // feed_watchdog();
        // error_code();
    }
}
